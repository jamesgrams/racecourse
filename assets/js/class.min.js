var classContents,classId,classIsSaving;window.addEventListener("DOMContentLoaded",loadClass);var classNewCategoryCount=0,CATEGORY_SAVE_ERROR_MESSAGE="Your data could not be saved. Please try again.",CATEGORY_NEW_CATEGORY_DATA={name:"",id:"new",content:""};function loadClass(){setUserName();var e=[{name:LOG_OUT_STRING,action:logout}],t=new URLSearchParams(window.location.search),s=parseInt(t.get("admin"));classIsSaving=!(classContents={}),classNewCategoryCount=0,classId=t.get("id"),s&&(e.unshift({name:"Save",action:saveState}),e.unshift({name:"View",action:function(){window.open("/class?id="+classId)}})),setActionButtons(e),makeRequest("GET","/api/class",{id:t.get("id")},function(e){var t,n=JSON.parse(e).items[0].name,a=document.querySelector("head title");a.innerHTML=a.innerHTML.replace("Class",n),s?((t=document.createElement("input")).setAttribute("type","text"),t.value=n,document.querySelector(".class-title").appendChild(t)):document.querySelector(".class-title").innerText=n},function(e){defaultError;try{var t=JSON.parse(e);t.errorMessage&&t.errorMessage}catch(e){}}),makeRequest("GET","/api/category",{class_id:t.get("id")},function(e){var t=JSON.parse(e).items;s&&t.push(CATEGORY_NEW_CATEGORY_DATA);for(var n=0;n<t.length;n++)addCategory(t[n],s);t.length&&document.querySelector(".categories li").click()},function(e){defaultError;try{var t=JSON.parse(e);t.errorMessage&&t.errorMessage}catch(e){}})}function saveState(){var e,l;classIsSaving||(classIsSaving=!0,document.querySelector("header button:nth-child(2)").innerText="Saving...",e=document.querySelector(".class-title").querySelector("input").value,l=!1,makeRequest("PUT","/api/class",{id:classId,name:e},function(){saveContents();function a(){0==--t&&(classIsSaving=!1,document.querySelector("header button:nth-child(2)").innerText="Save",l&&alert(CATEGORY_SAVE_ERROR_MESSAGE))}for(var e=document.querySelectorAll(".categories li"),t=e.length,n=Object.keys(classContents),s=[],i=0;i<n.length;i++)document.querySelector(".categories li[data-id='"+n[i]+"']")||s.push(n[i]);t+=s.length;for(i=0;i<s.length;i++)makeRequest("DELETE","/api/category",{id:s[i],class_id:classId},function(e){return function(){delete classContents[e],a()}}(s[i]),function(){l=!0,a()});for(i=0;i<e.length;i++){var c=e[i].getAttribute("data-id"),o=classContents[c],r=e[i].querySelector("input").value;if(c.toString().match(/^new/)){if(!r)return void a();makeRequest("POST","/api/category",{content:o,name:r,class_id:classId,display_order:i},function(n){return function(e){try{var t=JSON.parse(e).id;document.querySelector(".categories li[data-id='"+n+"']").setAttribute("data-id",t),classContents[t]=classContents[n],delete classContents[n]}catch(e){console.log(e),l=!0}a()}}(c),function(){l=!0,a()})}else makeRequest("PUT","/api/category",{id:c,content:o,name:r,class_id:classId,display_order:i},a,function(){l=!0,a()})}},function(){alert(CATEGORY_SAVE_ERROR_MESSAGE)}))}function addCategory(e,n){"new"==(e=JSON.parse(JSON.stringify(e))).id&&(e.id="new"+classNewCategoryCount,classNewCategoryCount++);var t,a,s,i,c=document.createElement("li");c.setAttribute("data-id",e.id),n?((t=document.createElement("input")).setAttribute("type","text"),t.value=e.name,c.appendChild(t),(a=document.createElement("button")).innerText="❌",c.appendChild(a),a.onclick=function(e){c.classList.contains("selected")&&document.querySelector(".categories li:not(.selected)").click(),this.parentElement.parentElement.removeChild(this.parentElement),e.stopPropagation()},(s=document.createElement("button")).innerText="⬆️",c.appendChild(s),s.onclick=function(e){var t=c.previousElementSibling;t&&c.parentNode.insertBefore(c,t)},(i=document.createElement("button")).innerText="⬇️",c.appendChild(i),i.onclick=function(e){var t=c.nextElementSibling;t&&c.parentNode.insertBefore(c,t.nextElementSibling)},e.id.toString().match(/^new/)&&(a.classList.add("hidden"),s.classList.add("hidden"),i.classList.add("hidden")),n&&e.id.toString().match(/^new/)&&(t.oninput=function(){addCategory(CATEGORY_NEW_CATEGORY_DATA,n),t.oninput=null,a.classList.remove("hidden"),s.classList.remove("hidden"),i.classList.remove("hidden")})):c.innerText=e.name,classContents[e.id]=e.content,c.onclick=function(){var e,t;this.classList.contains("selected")||(e=this.getAttribute("data-id"),(t=document.querySelector(".categories li.selected"))&&n&&saveContents(),n?(tinyMCE.remove(".content .editor"),document.querySelector(".editor").innerHTML=classContents[e],tinymce.init({selector:".editor"})):document.querySelector(".editor").innerHTML=classContents[e],t&&t.classList.remove("selected"),this.classList.add("selected"))},document.querySelector(".categories").appendChild(c)}function saveContents(){var e=document.querySelector(".categories li.selected").getAttribute("data-id"),t=tinymce.activeEditor.getContent();classContents[e]=t}