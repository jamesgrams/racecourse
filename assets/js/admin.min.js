window.addEventListener("DOMContentLoaded",loadAdmin);var adminMakingRequest,ADMIN_USER_FIELDS=["first","last","email","password","is_global_admin"],ADMIN_CLASS_FIELDS=["name"],ADMIN_NEW_ROW_VALUES={"/api/user":{id:"new",first:"New",last:"User",email:"new@grams.family",password:"",is_global_admin:0},"/api/class":{id:"new",name:"New Class"}},ADMIN_PASSWORD_PLACEHOLDER="*******";function loadAdmin(){setUserName(),setActionButtons([{name:"Users",action:function(){directPage("/admin?type=user")}},{name:"Classes",action:function(){directPage("/admin?type=class")}},{name:LOG_OUT_STRING,action:logout}]),adminMakingRequest=!1,"user"==new URLSearchParams(window.location.search).get("type")?adminLoadTable("/api/user",ADMIN_USER_FIELDS):adminLoadTable("/api/class",ADMIN_CLASS_FIELDS)}function adminLoadTable(c,u){var m=document.querySelector("table");m.innerHTML="",makeRequest("GET",c,{},function(e){try{var t=JSON.parse(e).items;if(t.length){u=u||Object.keys(ADMIN_NEW_ROW_VALUES[c]);var n=document.createElement("thead"),a=document.createElement("tr");n.appendChild(a);for(var i=0;i<u.length;i++){for(var d=document.createElement("th"),r=u[i].split("_"),o=[],s=0;s<r.length;s++)o.push(capitalizeFirstLetter(r[s]));d.innerText=o.join(" "),a.appendChild(d)}(d=document.createElement("th")).innerText="Actions",a.appendChild(d),m.appendChild(n);for(var l=document.createElement("tbody"),i=0;i<t.length;i++)adminCreateRow(t[i],u,l,c);adminCreateRow(ADMIN_NEW_ROW_VALUES[c],u,l,c),m.appendChild(l)}}catch(e){createToast(DEFAULT_ERROR),console.log(e)}})}function adminCreateRow(e,t,n,a){var i=document.createElement("tr");i.setAttribute("data-id",e.id);for(var d=0;d<t.length;d++)adminCreateCell(t[d],e[t[d]],i,a);var r=document.createElement("td");r.classList.add("action-cell");var p,o,s=document.createElement("button");"new"==e.id&&s.classList.add("hidden"),s.innerText="❌",s.onclick=function(){var e;!adminMakingRequest&&window.confirm("Are you sure you want to delete this entry?")&&(adminMakingRequest=!0,e=s.parentNode.parentNode.getAttribute("data-id"),makeRequest("DELETE",a,{id:e},function(){s.parentNode.parentNode.parentNode.removeChild(s.parentNode.parentNode),createToast(DELETE_SUCCESSFUL_MESSAGE),adminMakingRequest=!1},function(){createToast(DELETE_FAILED_MESSAGE),adminMakingRequest=!1}))},"/api/user"===a?(p=document.createElement("button"),"new"==e.id&&p.classList.add("hidden"),p.innerText="📖",p.onclick=function(){adminMakingRequest||(p.parentNode.querySelector(".registration")?document.querySelectorAll(".registration").forEach(function(e){e.parentElement.removeChild(e)}):(adminMakingRequest=!0,makeRequest("GET","/api/class",{},function(e){var m=JSON.parse(e).items;makeRequest("GET","/api/class-user",{user_id:p.parentElement.parentElement.getAttribute("data-id")},function(e){document.querySelectorAll(".registration").forEach(function(e){e.parentElement.removeChild(e)});for(var t=JSON.parse(e).items,n={},a=0;a<t.length;a++)n[t[a].class_id]={relation_id:t[a].id,user_id:t[a].user_id,is_admin:t[a].is_admin};var i=document.createElement("div");i.classList.add("registration");var d=document.createElement("div");d.classList.add("student-registration"),d.innerText="Student",i.appendChild(d);var r=document.createElement("div");r.classList.add("admin-registration"),r.innerText="Admin",i.appendChild(r);var o=document.createElement("div");o.classList.add("join-registration"),o.innerText="Available",i.appendChild(o);for(a=0;a<m.length;a++){var s=document.createElement("div");s.classList.add("registration-class"),s.innerText=m[a].name,s.setAttribute("data-id",m[a].id);function l(e,n){var t,a,i,d,r,o,s;adminMakingRequest||(adminMakingRequest=!0,t=n.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("data-id"),a=n.parentNode.innerText.split("⬆️")[0],i=n.parentNode.getAttribute("data-id"),d=n.parentNode.getAttribute("data-relation-id"),r=function(){e.appendChild(n.parentNode),createToast(SAVE_SUCCESSFUL_MESSAGE+" for "+a),adminMakingRequest=!1},o=function(){createToast(SAVE_ERROR_MESSAGE+" for "+a),adminMakingRequest=!1},s=function(e){var t=JSON.parse(e);n.parentNode.setAttribute("data-relation-id",t.id),r()},e.classList.contains("join-registration")?makeRequest("DELETE","/api/class-user",{id:d},r,o):e.classList.contains("admin-registration")?n.parentNode.parentNode.classList.contains("join-registration")?makeRequest("POST","/api/class-user",{class_id:i,user_id:t,is_admin:1},s,o):makeRequest("PUT","/api/class-user",{id:d,is_admin:1},r,o):n.parentNode.parentNode.classList.contains("join-registration")?makeRequest("POST","/api/class-user",{class_id:i,user_id:t,is_admin:0},s,o):makeRequest("PUT","/api/class-user",{id:d,is_admin:0},r,o))}var c=document.createElement("button");c.innerText="⬆️",s.appendChild(c),c.onclick=function(e){var t=this.parentNode.parentNode.previousElementSibling?this.parentNode.parentNode.previousElementSibling:this.parentNode.parentNode.nextElementSibling.nextElementSibling;l(t,this)};var u=document.createElement("button");u.innerText="⬇️",s.appendChild(u),u.onclick=function(e){var t=this.parentNode.parentNode.nextElementSibling?this.parentNode.parentNode.nextElementSibling:this.parentNode.parentNode.previousElementSibling.previousElementSibling;l(t,this)},n[m[a].id]?(s.setAttribute("data-relation-id",n[m[a].id].relation_id),n[m[a].id].is_admin?r.appendChild(s):d.appendChild(s)):o.appendChild(s)}p.parentElement.insertBefore(i,p.nextElementSibling),adminMakingRequest=!1},function(){createToast(DEFAULT_ERROR),adminMakingRequest=!1})},function(){createToast(DEFAULT_ERROR),adminMakingRequest=!1})))},r.appendChild(p)):(o=document.createElement("button"),"new"==e.id&&o.classList.add("hidden"),o.innerText="➡️",o.onclick=function(){directPage("/class?id="+o.parentNode.parentNode.getAttribute("data-id")+"&admin=1")},r.appendChild(o)),r.appendChild(s),i.appendChild(r),n.appendChild(i)}function adminCreateCell(e,t,o,s){var l,n=document.createElement("td");n.setAttribute("data-column",e),n.innerText=void 0!==t?t:"","new"==o.getAttribute("data-id")&&n.setAttribute("data-default",1),"password"===e&&(n.innerText=ADMIN_PASSWORD_PLACEHOLDER),o.appendChild(n),n.onclick=(l=n,function(e){var d,r;l.querySelector("input")||adminMakingRequest||(d=l.innerText,document.body.click(),(r=document.createElement("input")).oninput=function(){l.removeAttribute("data-default")},r.onkeydown=function(e){9===e.which&&e.preventDefault()},r.onkeyup=function(e){var t,n;9===e.which?(t=this.parentNode.nextElementSibling)&&!t.classList.contains("action-cell")?t.click():(n=this.parentNode.parentNode.nextElementSibling)&&n.querySelector("td").click():13===e.which&&document.body.click()},"password"!=l.getAttribute("data-column")&&(l.getAttribute("data-default")?r.placeholder=l.innerText:r.value=l.innerText),l.innerHTML="",l.appendChild(r),r.focus(),document.body.onclick=function(){if(r.value&&!adminMakingRequest){adminMakingRequest=!0,l.innerText=r.value?r.value:r.placeholder?r.placeholder:"";var e=l.parentNode.getAttribute("data-id");if("new"===e){for(var t=l.parentNode.querySelectorAll("td:not(.action-cell)"),n={},a=0;a<t.length;a++){var i=t[a].getAttribute("data-column");"password"!==i||t[a].innerText?n[i]=t[a].innerText:n[i]=Math.random().toString(36).slice(2)}makeRequest("POST",s,n,function(e){"password"==l.getAttribute("data-column")&&(l.innerText=ADMIN_PASSWORD_PLACEHOLDER);var t=JSON.parse(e).id;l.parentNode.setAttribute("data-id",t),l.parentNode.querySelectorAll("button").forEach(function(e){e.classList.remove("hidden")}),createToast(SAVE_SUCCESSFUL_MESSAGE+" for "+l.getAttribute("data-column")),adminCreateRow(ADMIN_NEW_ROW_VALUES[s],"/api/user"===s?ADMIN_USER_FIELDS:ADMIN_CLASS_FIELDS,o.parentNode,s),adminMakingRequest=!1},function(){"password"==!l.getAttribute("data-column")&&(l.innerText=d),createToast(SAVE_ERROR_MESSAGE+" for "+l.getAttribute("data-column")),adminMakingRequest=!1})}else(n={id:e})[l.getAttribute("data-column")]=l.innerText,makeRequest("PUT",s,n,function(){"password"==l.getAttribute("data-column")&&(l.innerText=ADMIN_PASSWORD_PLACEHOLDER),createToast(SAVE_SUCCESSFUL_MESSAGE+" for "+l.getAttribute("data-column")),adminMakingRequest=!1},function(){"password"==!l.getAttribute("data-column")&&(l.innerText=d),createToast(SAVE_ERROR_MESSAGE+" for "+l.getAttribute("data-column")),adminMakingRequest=!1})}else l.innerText=d;document.body.onclick=null}),e.stopPropagation()})}